apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "external-dns.labels" . | nindent 4 }}
    addon.vke.volcengine.com/status-check: {{ .Release.Name }}
    k8s-app: {{ .Release.Name }}
spec:
  replicas: {{ ((lookup "apps/v1" "Deployment" "kube-system" "external-dns").spec).replicas | default 1 }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
  selector:
    matchLabels:
      k8s-app: {{ .Release.Name }}
  template:
    metadata:
      labels:
        {{- include "external-dns.labels" . | nindent 8 }}
        addon.vke.volcengine.com/status-check: {{ .Release.Name }}
        k8s-app: {{ .Release.Name }}
    spec:
      {{- if eq .Values.publicConfig.deployNodeType "VirtualNode" }}
      dnsPolicy: ClusterFirst
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node.kubernetes.io/instance-type
                    operator: In
                    values:
                      - virtual-node
                  - key: "node.kubernetes.io/instance-type"
                    operator: NotIn
                    values:
                      - "dcp-node"
          preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                  - key: cluster.vke.volcengine.com/enable-autoscaling
                    operator: NotIn
                    values:
                      - "true"
              weight: 100
      tolerations:
        - key: vci.vke.volcengine.com/node-type
          operator: Exists
        - key: CriticalAddonsOnly
          operator: Exists
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          effect: NoSchedule
      {{- else }}
      dnsPolicy: ClusterFirst
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: "node.kubernetes.io/instance-type"
                    operator: NotIn
                    values:
                      - "dcp-node"
          preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                  - key: cluster.vke.volcengine.com/enable-autoscaling
                    operator: NotIn
                    values:
                      - "true"
              weight: 100
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          effect: NoSchedule
      {{- end }}
      serviceAccountName: {{ include "external-dns.serviceAccountName" . }}
      nodeSelector:
        kubernetes.io/os: linux
      containers:
      - name: controller
        image: {{ .Values.publicConfig.image.controller.repository }}:{{ .Values.publicConfig.image.controller.tag }}
        args:
        - --source=service
        - --provider=webhook
        - --interval={{ .Values.userConfig.args.controller.interval }}
        - --log-level={{ .Values.userConfig.args.controller.logLevel }}
        - --publish-internal-services
        - --policy=sync
        - --domain-filter={{ .Values.userConfig.args.controller.domainFilter }}
        - --registry=noop
        resources:
          limits:
            memory: {{ .Values.userConfig.Resources.controller.Limits.Memory }}
            cpu: {{ .Values.userConfig.Resources.controller.Limits.Cpu }}
          requests:
            cpu: {{ .Values.userConfig.Resources.controller.Requests.Cpu }}
            memory: {{ .Values.userConfig.Resources.controller.Requests.Memory }}
      - name: provider
        image: {{ .Values.publicConfig.image.provider.repository }}:{{ .Values.publicConfig.image.provider.tag }}
        command:
        - /opt/external-dns-volcengine-webhook
        args:
        - start
        - --port=8888
        - --debug={{ .Values.userConfig.args.provider.enableDebug }}
        env:
        - name: VOLCENGINE_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-credentials
              key: access-key
        - name: VOLCENGINE_ACCESS_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-credentials
              key: access-secret
        - name: VOLCENGINE_VPC
          value: {{ .Values.userConfig.env.vpc | quote }}
        - name: VOLCENGINE_REGION
          value: {{ .Values.userConfig.env.region | quote }}
        - name: VOLCENGINE_ENDPOINT
          value: {{ .Values.userConfig.env.endpoint | quote }}
        resources:
          limits:
            memory: {{ .Values.userConfig.Resources.provider.Limits.Memory }}
            cpu: {{ .Values.userConfig.Resources.provider.Limits.Cpu }}
          requests:
            cpu: {{ .Values.userConfig.Resources.provider.Requests.Cpu }}
            memory: {{ .Values.userConfig.Resources.provider.Requests.Memory }} 